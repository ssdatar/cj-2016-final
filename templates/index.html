{% include 'partials/head.html' %}

<body>
  <div class="container">

    <div id="header">
      <h1 class="text-center">Registered sex offenders in California</h1>
      <!-- <h3 class="text-center">Too broad or too harsh?</h3> -->
    </div>

    <div id="big-wrapper">
      <p class="big-text">This website lets you look at data on sex offenders in California counties through various lenses: how long they have been in the registry, how old they are, what their race is, and what crime they've committed. You can use the menu below to choose different filters.</p>

      <p class="big-text">The categories are groupings by age: Minor (below 18 years), Young (19 - 39 years), Middle age (40 - 54 years), and Old (55 years and above). Ethnicities are as reported by the sex offender registry maintained by the <a href="http://www.meganslaw.ca.gov/search_main.aspx">California State Department of Justice</a>. The income data comes from the <a href="http://www.census.gov/did/www/saipe/data/statecounty/data/2014.html">2014 Small Area and Income Estimates</a> of the US Census.</p>

      <p class="big-text">California created a sex registry in 1947 as a tracking tool for law enforcement. Today, the list contains over 100,000 registered sex offenders, mainly because California requires all sex offenders, regardless of the type of offense, to register for life. Not all of them are made public: this tool reflects the number of registrants displayed on the Public Meganâ€™s Law website, which does not include the total of registrants that are No Post or Excluded. </p>

    </div>  

    <!-- <div class="row">
      <div class="col-md-8 col-md-offset-2">
        <p class="intro-text text-justify">Choose a county to see the list of sex offenders in your county.</p>
      </div>
    </div> -->

    <div class="row">

      <div class="col-md-4">
        <p class="intro-text text-justify">Choose a county</p>

        <form id="user-location" action="{{url_for('results')}}" method="GET">
          <select name="county" class="form-control" id="county-name">
            <!-- <option value="all">All</option> -->
            <option value="Alameda">Alameda</option>
            <option value="Alpine">Alpine</option>
            <option value="Amador">Amador</option>
            <option value="Butte">Butte</option>
            <option value="Calaveras">Calaveras</option>
            <option value="Colusa">Colusa</option>
            <option value="Contra Costa">Contra Costa</option>
            <option value="Del Norte">Del Norte</option>
            <option value="El Dorado">El Dorado</option>
            <option value="Fresno">Fresno</option>
            <option value="Glenn">Glenn</option>
            <option value="Humboldt">Humboldt</option>
            <option value="Imperial">Imperial</option>
            <option value="Inyo">Inyo</option>
            <option value="Kern">Kern</option>
            <option value="Kings">Kings</option>
            <option value="Lake">Lake</option>
            <option value="Lassen">Lassen</option>
            <option value="Los Angeles">Los Angeles</option>
            <option value="Madera">Madera</option>
            <option value="Marin">Marin</option>
            <option value="Mariposa">Mariposa</option>
            <option value="Mendocino">Mendocino</option>
            <option value="Merced">Merced</option>
            <option value="Modoc">Modoc</option>
            <option value="Mono">Mono</option>
            <option value="Monterey">Monterey</option>
            <option value="Napa">Napa</option>
            <option value="Nevada">Nevada</option>
            <option value="Orange">Orange</option>
            <option value="Placer">Placer</option>
            <option value="Plumas">Plumas</option>
            <option value="Riverside">Riverside</option>
            <option value="Sacramento">Sacramento</option>
            <option value="San Benito">San Benito</option>
            <option value="San Bernardino">San Bernardino</option>
            <option value="San Diego">San Diego</option>
            <option value="San Francisco">San Francisco</option>
            <option value="San Joaquin">San Joaquin</option>
            <option value="San Luis Obispo">San Luis Obispo</option>
            <option value="San Mateo">San Mateo</option>
            <option value="Santa Barbara">Santa Barbara</option>
            <option value="Santa Clara">Santa Clara</option>
            <option value="Santa Cruz">Santa Cruz</option>
            <option value="Shasta">Shasta</option>
            <option value="Sierra">Sierra</option>
            <option value="Siskiyou">Siskiyou</option>
            <option value="Solano">Solano</option>
            <option value="Sonoma">Sonoma</option>
            <option value="Stanislaus">Stanislaus</option>
            <option value="Sutter">Sutter</option>
            <option value="Tehama">Tehama</option>
            <option value="Trinity">Trinity</option>
            <option value="Tulare">Tulare</option>
            <option value="Tuolumne">Tuolumne</option>
            <option value="Ventura">Ventura</option>
            <option value="Yolo">Yolo</option>
            <option value="Yuba">Yuba</option>
          </select>
  
        <!-- </form> -->

        <p class="intro-text">Choose a category</p>
        <!-- <form id="category-input"> -->
          <select name="categ-name" class="form-control select" id="categ-option">
            <option value="all">All</option>
            <option value="minor">Minor</option>
            <option value="young">Young</option>
            <option value="middle">Middle age</option>
            <option value="old">Old</option>
          </select>
          <!-- <input type="submit" id="categ-button" class="btn btn-primary" value="Show me" /> -->
          </label>

        <!-- </form> -->

        <p class="intro-text">Choose an ethnicity</p>
        <!-- <form action="" id="race-input" class="form"> -->
          <select name="ethnicity" class="form-control select" id="race-option">
            <option value="all">All</option>
            <option value="american indian">American Indian</option>
            <option value="asian indian">Asian Indian</option>
            <option value="black">Black</option>
            <option value="cambodian">Cambodian</option>
            <option value="chinese">Chinese</option>
            <option value="filipino">Filipino</option>
            <option value="guamanian">Guamanian</option>
            <option value="hawaiian">Hawaiian</option>
            <option value="hispanic">Hispanic</option>
            <option value="japanese">Japanese</option>
            <option value="korean">Korean</option>
            <option value="laotian">Laotian</option>
            <option value="other">Other</option>
            <option value="other asian">Other Asian</option>
            <option value="pacific islander">Pacific Islander</option>
            <option value="samoan">Samoan</option>
            <option value="unknown">Unknown</option>
            <option value="vietnamese">Vietnamese</option>
            <option value="white">White</option>
          </select>

          <!-- <input type="submit" id="race-button" class="btn btn-primary" value="Show me" /> -->
          

          <p class="intro-text">Choose a gender</p>
        <!-- <form action="" id="race-input" class="form"> -->
          <select name="sex" class="form-control select" id="sex-option">
            <option value="all">All</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="unknown">Unknown</option>
          </select>

          <!-- <input type="submit" id="race-button" class="btn btn-primary" value="Show me" /> -->
          <input type="submit" id="form-button" class="btn btn-primary" value="Show me" />
        </form> 

        <p class="map-text">The map shows the county-wise population of sex offenders per 1,000 persons. The population data comes from the 2016 estimates of the <a href="http://www.dof.ca.gov/research/demographic/reports/estimates/e-1/view.php">California Department of Finance</a>.</p>

              
      </div>

      <div class="col-md-8">
        <div id="map"></div>
      </div>

      <div class="col-md-4 col-sm-6 col-xs-6 col-md-offset-1">
        <h3 class="list-head">Summary statistics</h3>
        <ul class="list">
          <li>
            57,992
            <p class="list-sub">sex offenders in California</p>
          </li>

          <li>
            57,115
            <p class="list-sub">males</p>
          </li>

          <li>
            853
            <p class="list-sub">females</p>
          </li>
        </ul>  
      </div>

      <div class="col-md-4 col-sm-6 col-xs-6 col-md-offset-1">
        <h3 class="list-head">Top 5 counties with sex offenders</h3>
        <ul class="list">
          {% for d in t %}
          <li>
            {{ d.county }}
            <p class="list-sub">{{ d.off_rate }} per 1,000 people</p>
          </li>
          {% endfor %}
        </ul>  
      </div>
      
    </div>

  </div>
  {% include 'partials/footer.html' %}

  <script src="{{url_for('static', filename='js/jquery.min.js')}}"></script>
  <script src="{{url_for('static', filename='js/ca_counties.js')}}"></script>
  <script src="{{url_for('static', filename='js/leaflet.js')}}"></script>
  <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="{{url_for('static', filename='js/script.js')}}"></script>
  <script type="text/javascript">
    var map = L.map('map', {
      scrollWheelZoom: false,
      center: [37.753972, -119.431297],
      zoom: 6
    });

    var ca_counties = counties;
    var offenders = {{ o|tojson }};

    ca_counties.features.forEach(function(d) {
      offenders.forEach(function(c) {
        if(c.county == d.properties.name) {
          d.properties.off = c.off_rate;
        }
      });
    });

    var dataRange = d3.extent(ca_counties.features, function(d) {
      return +d.properties.off;
    });

    console.log(dataRange);

    var colorRange = ['#FFEDA0','#FEB24C','#E31A1C','#BD0026','800026'];

    var colorScale = d3.scale.quantile()
    .domain(dataRange)
    .range(colorRange);


    L.tileLayer("http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png", 
      {
        attribution: '&copy; Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
        maxZoom: 18
    }).addTo(map);

    // Add county shape with styles
    L.geoJson(ca_counties, {style: style}).addTo(map);

    // Function to style the county shapes
    function style(feature) {
      return {
          fillColor: getColor(+feature.properties.off),
          weight: 1,
          opacity: 1,
          color: '#545454',
          fillOpacity: 0.7
      };
    }

    function getColor(d) {
      return d > 3.2 ? '#800026' :
             d > 2.4  ? '#BD0026' :
             d > 1.6  ? '#E31A1C' :
             d > 0.8  ? '#FEB24C' :
                        '#FFEDA0';
    }

    var legend = L.control({position: 'bottomleft'});

    legend.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info legend'),
          grades = [0.02, 0.8, 1.6, 2.4, 3.2],
          labels = [];

      // loop through our density intervals and generate a label with a colored square for each interval
      for (var i = 0; i < grades.length; i++) {
          div.innerHTML +=
              '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
              grades[i] + ' ' + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : ' and above');
      }

      return div;
    };
    legend.addTo(map);

  </script>
</body>
</html>