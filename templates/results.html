{% include 'partials/head.html' %}

<body>
  <div class="container">

    <h1 class="text-center">Sex offenders in {{results[0]['county']}} county</h1>
    
    <div class="row">
      <div class="col-md-6">
        <p class="intro-text">You searched for sex offenders in {{ results[0]['county'] }} county with category "{{ f[1] }}" and ethnicity "{{ f[2] }}".</p>

        <!-- Summary statistics -->
        <div id="stats-panel">          
          <div class="summary" id="total">
            <p class="big" id="total-num">{{results|length}}</p>
            <p class="subhead" id="total-sub">total sex offenders</p> 
          </div>

          <div id="compliance" class="summary">
            {% for d in  results|groupby('compliance_status') %}
            <div class="num-wrapper">
              <p class="big" id="race-1">{{d[1]|length}}</p> 
              <p class="subhead" id="race-sub1">{{d[0]}}</p>
            </div>
            {% endfor %}
          </div>

          <div class="summary" id="race-panel">
            
          </div>
        </div>
      </div>
      
      <!-- Map of chosen sex offenders -->
      <div class="col-md-6">
        <div id="result-map"></div>
      </div>
    </div>



    <div class="row">
      <div class="col-md-6">
        <div id="chart-1" class="chart"></div>
      </div>

      <div class="col-md-6">
        <div id="chart-2" class="chart"></div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-condensed table-striped table-bordered">
        <thead>
          <tr>
            <th>Name</th>
            <th>Age</th>
            <th>Sex</th>
            <th>Ethnicity</th>
            <th>Category</th>
            <th>Offense</th>
            <th>Compliance status</th>
          </tr>
        </thead>
        <tbody>
          {% for r in results %}
            <tr>
              <td>{{ r.name }}</td>
              <td>{{ r.age }}</td>
              <td>{{ r.gender }}</td>
              <td>{{ r.ethnicity }}</td>
              <td>{{ r.category }}</td>
              <td>{{ r.offense_desc }}</td>
              <td>{{ r.compliance_status }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>

  <script src="{{url_for('static', filename='js/jquery.min.js')}}"></script>
  <script src="{{url_for('static', filename='js/highcharts.js')}}"></script>
  <script src="//cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
  <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
  <script src="{{url_for('static', filename='js/script.js')}}"></script>
  <script src="{{url_for('static', filename='js/ca_counties.js')}}"></script>

  <script type="text/javascript">
  $(document).ready(function() { 
    var data = {{results|tojson}};

    var d = {{results|groupby('ethnicity')|tojson}};

    var ca_counties = counties;
    console.log(d)

    var raceBreakup = _.groupBy(data, function(d) { return d.ethnicity; });

    console.log(raceBreakup);

    //$("#race-1").text(raceBreakup.Black.length);
    //$("#race-2").text(raceBreakup.Hispanic.length);

    makeCategChart(data);


    var map = L.map('result-map', {
      scrollWheelZoom: false,
      center: [37.753972, -119.431297],
      zoom: 6
    });

    L.tileLayer("http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png", 
      {
        attribution: '&copy; Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
        maxZoom: 18
    }).addTo(map);

    // Add county shape with styles
    L.geoJson(ca_counties, {style: style}).addTo(map);

    // Build data for sex offenders
    var data = {
      "type": "FeatureCollection",
      "features": [
        {% for obj in results %}
        {
          "type": "Feature",
          "properties": {
            "name": "{{ obj.name }}",
            "age": "{{ obj.age }}",
            "race": "{{ obj.ethnicity }}",
            "offense": "{{ obj.offense_desc }}",
            "status": "{{ obj.compliance_status }}"
          },
          "geometry": {
                      "type": "Point",
                      "coordinates": [{{ obj.lon }}, {{ obj.lat }}]
                    }
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    };

    // Add the dots
    var geojsonMarkerOptions = {
                      radius: 5,
                      fillColor: "#ff7800",
                      color: "#fff",
                      weight: 1,
                      opacity: .7,
                      fillOpacity: 0.7
                  };

    var dataLayer = L.geoJson(data, {
                pointToLayer: function (feature, latlng) {
                  return L.circleMarker(latlng, geojsonMarkerOptions);
                },
                onEachFeature: function(feature, layer) {
                  //Info shown on map popup
                  layer.bindPopup('<strong>' + feature.properties.name + '</strong>' + '<br> Age: ' + feature.properties.age + '<br> Race: ' + feature.properties.race + '<br>Offense: ' + feature.properties.offense);
                  }
              });
    map.addLayer(dataLayer);

    
    // Function to style the county shapes
    function style(feature) {
      return {
          fillColor: '#99d8c9',
          weight: 2,
          opacity: 1,
          color: 'white',
          dashArray: '3',
          fillOpacity: 0.7
      };
    }

    function makeCategChart(data) {
      var chartData = [],
          categs = [], 
          group;

      group = _.groupBy(data, function(d) {return d.category; });

      for (var i in group) {
        categs.push(i);
        chartData.push(group[i].length);
      }

      $(function () {
        $('#chart-1').highcharts({
            chart: {
                type: 'column'
            },
            title: {
                text: 'Sex offenders by category'
            },
            // subtitle: {
            //     text: 'Source: WorldClimate.com'
            // },
            xAxis: {
                categories: categs
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Number of sex offenders',
                    align: 'high'
                },
                labels: {
                  overflow: 'justify'
                },
            },
            credits: {
              enabled: false
            },
            plotOptions: {
              column: {
                dataLabels: {
                    enabled: true
                }
              }
            },
            series: [{
              name: 'Category',
              data: chartData
            }]
          });
        });
    }




  });

  </script>
</body>